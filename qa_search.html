<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æœŸåˆŠ QA æœå°‹</title>

  <!-- xlsx.jsï¼šç”¨ä¾†è®€å– Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont,
        "PingFang TC", "Microsoft JhengHei", sans-serif;
      background: #f5f5f7;
      color: #333;
    }

    .app-container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    h1 {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .subtitle {
      font-size: 13px;
      color: #666;
      margin-bottom: 20px;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      padding: 12px 16px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      margin-bottom: 16px;
    }

    .toolbar-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    label {
      font-size: 13px;
      color: #555;
    }

    input[type="file"] {
      font-size: 13px;
    }

    .search-input {
      flex: 1 1 220px;
      min-width: 200px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #ccc;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .search-input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      background: #2563eb;
      color: #fff;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s, box-shadow 0.2s, transform 0.05s;
    }

    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    button:hover {
      background: #1d4ed8;
      box-shadow: 0 4px 10px rgba(37, 99, 235, 0.25);
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
      box-shadow: none;
    }

    .btn-secondary:hover {
      background: #d1d5db;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .status-bar {
      font-size: 13px;
      color: #555;
      margin-bottom: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: baseline;
    }

    .status-bar span { white-space: nowrap; }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e5e7eb;
      font-size: 12px;
      color: #374151;
    }

    .results-container {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .empty-message {
      padding: 24px 16px;
      border-radius: 12px;
      background: #fff;
      text-align: center;
      color: #6b7280;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
    }

    /* å¹´åº¦ / å­£åˆ¥ æ¨™é¡Œ */
    .year-header {
      margin-top: 18px;
      margin-bottom: 4px;
      font-size: 18px;
      font-weight: 700;
      color: #111827;
    }

    .quarter-header {
      margin-left: 6px;
      margin-top: 8px;
      margin-bottom: 4px;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
    }

    /* å¡ç‰‡ç¸®æ’ï¼Œé¡¯ç¤ºå±¤æ¬¡ */
    .qa-card {
      margin-left: 16px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      overflow: hidden;
      border: 1px solid #e5e7eb;
      transition: box-shadow 0.15s, border-color 0.15s, transform 0.05s;
    }

    .qa-card.active {
      border-color: #2563eb;
      box-shadow: 0 6px 18px rgba(37, 99, 235, 0.2);
      transform: translateY(-1px);
    }

    .qa-header {
      padding: 10px 14px;
      background: #f9fafb;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      cursor: pointer;
    }

    .qa-header-main {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .qa-title {
      font-size: 15px;
      font-weight: 600;
      color: #111827;
    }

    .qa-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 12px;
      color: #6b7280;
    }

    .qa-meta span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .qa-keywords {
      font-size: 12px;
      color: #4b5563;
    }

    .qa-toggle-icon {
      font-size: 16px;
      color: #6b7280;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .qa-body {
      overflow: hidden;
      max-height: 0;
      padding: 0 14px;
      border-top: 1px solid #e5e7eb;
      transition: max-height 0.22s ease, padding-top 0.22s ease, padding-bottom 0.22s ease;
    }

    .qa-card.active .qa-body {
      padding-top: 10px;
      padding-bottom: 12px;
    }

    .qa-field {
      margin-bottom: 6px;
      font-size: 14px;
    }

    .qa-field label {
      display: inline-block;
      min-width: 70px;
      font-weight: 600;
      color: #374151;
    }

    .qa-field pre,
    .qa-field div {
      display: inline;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: inherit;
    }

    .qa-section-title {
      margin-top: 4px;
      margin-bottom: 2px;
      font-size: 13px;
      font-weight: 600;
      color: #4b5563;
    }

    .qa-section-text {
      font-size: 14px;
      color: #111827;
      white-space: pre-wrap;
      word-break: break-word;
      margin-bottom: 6px;
    }

    .highlight {
      background: #fef08a;
      padding: 0 2px;
      border-radius: 3px;
    }

    @media (max-width: 640px) {
      .qa-field label {
        display: block;
        margin-bottom: 2px;
      }

      .toolbar {
        align-items: stretch;
      }

      button {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <h1>æœŸåˆŠ QA æœå°‹ç³»çµ±</h1>
    <div class="subtitle">
      å¾ Excel è¼‰å…¥ï¼šQuarter / Year / Page / Title / Question / Answer / Note / Keyã€‚<br>
      ğŸ” é—œéµå­—åªåœ¨ <strong>Question / Answer</strong> ä¸­åš AND æœå°‹ï¼ˆå¤šå€‹é—œéµå­—ç”¨ç©ºç™½åˆ†éš”ï¼‰ï¼Œä¸¦æ”¯æ´ä»£ç¢¼å»æ‰ç¬¦è™Ÿæœå°‹ï¼Œä¾‹å¦‚ï¼š
      <code>COVID-19</code> å¯ç”¨ <code>covid</code> / <code>covid19</code>ï¼›<code>U07.1</code> å¯ç”¨ <code>u07.1</code> / <code>u071</code>ã€‚<br>
      ğŸ“„ æœƒè‡ªå‹•è®€å–ã€Œæ‰€æœ‰å·¥ä½œè¡¨ã€ä¸­æœ‰ Question/Answer æ¬„ä½çš„è³‡æ–™ï¼Œåˆä½µå¾Œé¡¯ç¤ºã€‚
    </div>

    <div class="toolbar">
      <div class="toolbar-group">
        <label for="fileInput">1. é¸æ“‡ QA Excel æª”ï¼š</label>
        <input id="fileInput" type="file" accept=".xlsx,.xls" />
      </div>

      <div class="toolbar-group" style="flex:1 1 auto;">
        <input
          id="searchInput"
          class="search-input"
          type="text"
          placeholder="2. è«‹è¼¸å…¥é—œéµå­—ï¼ˆç©ºç™½åˆ†éš”ï¼šå¦‚ covid-19 u07.1ï¼‰"
        />
        <button id="searchBtn" type="button">æœå°‹</button>
        <button id="clearBtn" type="button" class="btn-secondary">æ¸…é™¤</button>
      </div>
    </div>

    <div class="status-bar">
      <span id="loadStatus">å°šæœªè¼‰å…¥ Excel æª”</span>
      <span id="resultStatus"></span>
    </div>

    <div id="results" class="results-container">
      <div class="empty-message">
        è«‹å…ˆé¸æ“‡ Excel æª”ï¼Œè¼‰å…¥å®Œæˆå¾Œå³å¯è¼¸å…¥é—œéµå­—æœå°‹ã€‚<br />
        é—œéµå­—ä»¥ç©ºç™½åˆ†éš”ï¼Œ<strong>åªæœƒåœ¨ Question / Answer</strong> ä¸­åš AND æœå°‹ï¼Œä¸¦æ”¯æ´å»æ‰ç¬¦è™Ÿçš„ä»£ç¢¼æœå°‹ã€‚<br>
        æœƒè‡ªå‹•å¾æ‰€æœ‰å·¥ä½œè¡¨ä¸­åŒ¯å…¥åˆé©æ¬„ä½çš„è³‡æ–™ã€‚
      </div>
    </div>
  </div>

  <script>
    let qaData = [];      // æ­£è¦åŒ–å¾Œå®Œæ•´è³‡æ–™
    let filteredData = []; // æœå°‹çµæœ

    const fileInput = document.getElementById("fileInput");
    const searchInput = document.getElementById("searchInput");
    const searchBtn = document.getElementById("searchBtn");
    const clearBtn = document.getElementById("clearBtn");
    const loadStatus = document.getElementById("loadStatus");
    const resultStatus = document.getElementById("resultStatus");
    const resultsContainer = document.getElementById("results");

    fileInput.addEventListener("change", handleFile, false);
    searchBtn.addEventListener("click", doSearch);
    clearBtn.addEventListener("click", () => {
      searchInput.value = "";
      if (qaData.length === 0) return;
      filteredData = qaData;
      renderResults(filteredData, []);
      updateResultStatus();
      searchInput.focus();
    });
    searchInput.addEventListener("keyup", (e) => {
      if (e.key === "Enter") {
        doSearch();
      }
    });

    function normalize(str) {
      return String(str || "").toLowerCase();
    }

    // æœå°‹ç”¨ï¼šåŒæ™‚ä¿ç•™ã€ŒåŸå§‹å°å¯«ã€èˆ‡ã€Œå»æ‰éè‹±æ•¸å­—ã€ç‰ˆæœ¬
    function normalizeForSearch(str) {
      const raw = normalize(str);                 // åŸå§‹å°å¯«ï¼ˆå«ç¬¦è™Ÿï¼‰
      const plain = raw.replace(/[^a-z0-9]/g, ""); // å»æ‰ç¬¦è™Ÿï¼Œåªç•™ a-z0-9
      return { raw, plain };
    }

    function normalizeHeaderName(name) {
      return String(name || "")
        .trim()
        .toLowerCase()
        .replace(/[\s_]+/g, "")
        .replace(/[^a-z0-9]/g, "");
    }

    // æŠŠå­—ä¸²è½‰æˆæ•¸å­—ï¼Œå¤±æ•—å°±çµ¦ 0
    function toNumber(val) {
      const n = parseInt(val, 10);
      return isNaN(n) ? 0 : n;
    }

    // Quarter å¯èƒ½æ˜¯ 1ã€2ã€3ã€4 æˆ– Q1ã€1Q ç­‰ï¼ŒæŠ“è£¡é¢çš„æ•¸å­—
    function toQuarterNumber(val) {
      const m = String(val || "").match(/\d+/);
      if (!m) return 0;
      const n = parseInt(m[0], 10);
      return isNaN(n) ? 0 : n;
    }

    // ä¾ Yearâ†‘ã€Quarterâ†‘ã€Pageâ†‘ æ’åºï¼ˆ2015 â†’ 2016 â†’ 2017ï¼‰
    function sortByYearQuarterPage(arr) {
      return arr.slice().sort((a, b) => {
        const ya = toNumber(a.Year);
        const yb = toNumber(b.Year);
        if (ya !== yb) return ya - yb;        // å¹´åº¦ï¼šå°åˆ°å¤§

        const qa = toQuarterNumber(a.Quarter);
        const qb = toQuarterNumber(b.Quarter);
        if (qa !== qb) return qa - qb;        // å­£åº¦ï¼š1 â†’ 4

        const pa = toNumber(a.Page);
        const pb = toNumber(b.Page);
        return pa - pb;                       // é æ•¸ï¼šå°åˆ°å¤§
      });
    }

    function handleFile(evt) {
      const file = evt.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });

          if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
            loadStatus.textContent = "æ­¤æª”æ¡ˆæ²’æœ‰ä»»ä½•å·¥ä½œè¡¨ã€‚";
            resultsContainer.innerHTML =
              `<div class="empty-message">æª”æ¡ˆç‚ºç©ºã€‚</div>`;
            qaData = [];
            filteredData = [];
            updateResultStatus();
            return;
          }

          const headerCandidates = ["quarter","year","page","title","question","answer","note","key"];

          qaData = [];
          const sheetSummaries = [];

          // ğŸ” é€ä¸€è™•ç†æ‰€æœ‰å·¥ä½œè¡¨ï¼Œæ‰¾åˆ°æœ‰ QA æ¬„ä½çš„å°±åŒ¯å…¥
          workbook.SheetNames.forEach((sheetName) => {
            const ws = workbook.Sheets[sheetName];
            const rows = XLSX.utils.sheet_to_json(ws, {
              header: 1,
              defval: ""
            });
            if (!rows || rows.length === 0) return;

            let headerRowIndex = -1;
            let matchCountOnHeader = 0;

            for (let i = 0; i < rows.length; i++) {
              const row = rows[i];
              if (!row || row.length === 0) continue;
              let matchCount = 0;
              for (let c = 0; c < row.length; c++) {
                const normalized = normalizeHeaderName(row[c]);
                if (headerCandidates.includes(normalized)) {
                  matchCount++;
                }
              }
              if (matchCount >= 2) {
                headerRowIndex = i;
                matchCountOnHeader = matchCount;
                break; // ç”¨ç¬¬ä¸€å€‹ç¬¦åˆçš„æ¨™é¡Œåˆ—
              }
            }

            if (headerRowIndex === -1) {
              // é€™å€‹ sheet æ²’åµæ¸¬åˆ° QA æ¨™é¡Œåˆ—ï¼Œå°±ç•¥é
              return;
            }

            const headerRow = rows[headerRowIndex];
            const dataRows = rows.slice(headerRowIndex + 1);

            let countThisSheet = 0;

            dataRows.forEach((row) => {
              // åˆ¤æ–·æ˜¯ä¸æ˜¯æ•´åˆ—çœŸçš„éƒ½ç©ºç™½ï¼ˆé€£ Year/Quarter éƒ½æ²’æœ‰ï¼‰
              const allEmpty = row.every((cell) => String(cell).trim() === "");
              if (allEmpty) return;

              const obj = {
                Sheet: sheetName,
                Quarter: "",
                Year: "",
                Page: "",
                Title: "",
                Question: "",
                Answer: "",
                Note: "",
                Key: ""
              };

              for (let i = 0; i < headerRow.length; i++) {
                const rawHeader = headerRow[i];
                const cell = row[i];
                const norm = normalizeHeaderName(rawHeader);

                if (norm === "quarter") obj.Quarter = cell;
                else if (norm === "year") obj.Year = cell;
                else if (norm === "page") obj.Page = cell;
                else if (norm === "title") obj.Title = cell;
                else if (norm === "question") obj.Question = cell;
                else if (norm === "answer") obj.Answer = cell;
                else if (norm === "note") obj.Note = cell;
                else if (norm === "key") obj.Key = cell;
              }

              qaData.push(obj);
              countThisSheet++;
            });

            sheetSummaries.push({
              name: sheetName,
              headerRowIndex,
              matchCount: matchCountOnHeader,
              count: countThisSheet
            });
          });

          if (qaData.length === 0) {
            loadStatus.textContent = "æ²’æœ‰åœ¨ä»»ä½•å·¥ä½œè¡¨ä¸­æ‰¾åˆ° Question / Answer ç­‰æ¬„ä½ã€‚";
            resultsContainer.innerHTML =
              `<div class="empty-message">è«‹ç¢ºèª Excel ä¸­è‡³å°‘æœ‰ä¸€å¼µå·¥ä½œè¡¨å« Quarter / Year / Question / Answer ç­‰æ¬„ä½ã€‚</div>`;
            filteredData = [];
            updateResultStatus();
            return;
          }

          // è®€é€²ä¾†å°±å…ˆä¾ Year / Quarter / Page æ’å¥½
          qaData = sortByYearQuarterPage(qaData);
          filteredData = qaData;

          // çµ„åˆè¼‰å…¥æ‘˜è¦æ–‡å­—
          const sheetInfoText = sheetSummaries
            .map(s => `${s.name}ï¼š${s.count} ç­†ï¼ˆæ¨™é¡Œåˆ—ç¬¬ ${s.headerRowIndex + 1} è¡Œï¼ŒåŒ¹é…æ¬„ä½ ${s.matchCount}ï¼‰`)
            .join("ï¼› ");

          loadStatus.textContent =
            `å·²å¾ ${sheetSummaries.length} å€‹å·¥ä½œè¡¨åŒ¯å…¥ï¼Œå…± ${qaData.length} ç­†è³‡æ–™ã€‚${sheetInfoText ? " ä¾†æºï¼š" + sheetInfoText : ""}`;

          renderResults(filteredData, []);
          updateResultStatus();
        } catch (err) {
          console.error(err);
          loadStatus.textContent = "è¼‰å…¥ Excel ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼ã€‚";
          resultsContainer.innerHTML =
            `<div class="empty-message">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª Excel æª”æ¡ˆæ˜¯å¦ç‚ºæ¨™æº– .xlsx / .xls æ ¼å¼ã€‚</div>`;
          qaData = [];
          filteredData = [];
          updateResultStatus();
        }
      };

      reader.readAsArrayBuffer(file);
    }

    function doSearch() {
      if (qaData.length === 0) {
        alert("è«‹å…ˆé¸æ“‡ä¸¦è¼‰å…¥ Excel æª”ã€‚");
        return;
      }

      const rawInput = searchInput.value.trim();
      const keywordsRaw = rawInput
        .split(/\s+/)
        .filter(Boolean);

      if (keywordsRaw.length === 0) {
        filteredData = qaData;
        renderResults(filteredData, []);
        updateResultStatus();
        return;
      }

      // é å…ˆæŠŠé—œéµå­—åš normalizeForSearch
      const keywordObjs = keywordsRaw.map((kw) => normalizeForSearch(kw));

      filteredData = qaData.filter((row) => {
        // åªåœ¨ Question + Answer è£¡æœå°‹
        const qaText = `${row.Question || ""}  ${row.Answer || ""}`;
        const hay = normalizeForSearch(qaText);

        // æ¯ä¸€å€‹é—œéµå­—éƒ½è¦ matchï¼ˆANDï¼‰
        return keywordObjs.every((k) => {
          // å…ˆçœ‹ã€ŒåŸå§‹å°å¯«ã€æ˜¯å¦åŒ…å«ï¼Œä¾‹å¦‚ï¼šcovid vs covid-19
          if (k.raw && hay.raw.includes(k.raw)) return true;
          // å†çœ‹ã€Œå»æ‰ç¬¦è™Ÿã€æ˜¯å¦åŒ…å«ï¼Œä¾‹å¦‚ï¼šu071 vs u07.1ã€covid19 vs covid-19
          if (k.plain && hay.plain.includes(k.plain)) return true;
          return false;
        });
      });

      // çµæœä»ä¾ Year / Quarter / Page æ’ä¸€æ¬¡
      filteredData = sortByYearQuarterPage(filteredData);

      const keywordForHighlight = keywordObjs.map(k => k.raw).filter(Boolean);
      renderResults(filteredData, keywordForHighlight);
      updateResultStatus(keywordsRaw.map(k => k.toLowerCase()));
    }

    function updateResultStatus(keywords = []) {
      if (qaData.length === 0) {
        resultStatus.textContent = "";
        return;
      }
      if (!keywords || keywords.length === 0) {
        resultStatus.innerHTML =
          `<span class="badge">é¡¯ç¤ºå…¨éƒ¨ ${filteredData.length} ç­†</span>`;
      } else {
        resultStatus.innerHTML =
          `<span class="badge">é—œéµå­—ï¼š${keywords.join(" & ")}</span>` +
          ` <span class="badge">æœå°‹çµæœ ${filteredData.length} ç­†</span>`;
      }
    }

    function highlightText(text, keywords) {
      if (!keywords || keywords.length === 0) return escapeHtml(text);

      let escaped = escapeHtml(text);
      keywords.forEach((kw) => {
        if (!kw) return;
        const pattern = new RegExp("(" + escapeRegExp(kw) + ")", "ig");
        escaped = escaped.replace(pattern, `<span class="highlight">$1</span>`);
      });
      return escaped;
    }

    function escapeHtml(str) {
      return String(str || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function escapeRegExp(str) {
      return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }

    // ä¾ Year / Quarter å †ç–Šé¡¯ç¤º + å¡ç‰‡
    function renderResults(data, keywords) {
      if (!data || data.length === 0) {
        resultsContainer.innerHTML =
          `<div class="empty-message">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„çµæœã€‚</div>`;
        return;
      }

      resultsContainer.innerHTML = "";

      let currentYear = null;
      let currentQuarter = null;

      data.forEach((row, index) => {
        const year = row.Year || "";
        const quarterRaw = row.Quarter || "";

        // å¹´åº¦è®Šäº† â†’ åŠ  Year æ¨™é¡Œ
        if (year !== currentYear) {
          currentYear = year;
          currentQuarter = null;

          const yearHeader = document.createElement("div");
          yearHeader.className = "year-header";
          yearHeader.textContent = year ? String(year) : "(æœªå¡« Year)";
          resultsContainer.appendChild(yearHeader);
        }

        // å­£åº¦è®Šäº† â†’ åŠ  Quarter æ¨™é¡Œ
        if (quarterRaw !== currentQuarter) {
          currentQuarter = quarterRaw;

          const quarterHeader = document.createElement("div");
          quarterHeader.className = "quarter-header";

          const qStr = String(quarterRaw || "").trim();
          if (/^\d+$/.test(qStr)) {
            quarterHeader.textContent = `Q${qStr}`;
          } else if (qStr) {
            quarterHeader.textContent = qStr;
          } else {
            quarterHeader.textContent = "(æœªå¡« Quarter)";
          }

          resultsContainer.appendChild(quarterHeader);
        }

        // === å¡ç‰‡æœ¬é«” ===
        const card = document.createElement("div");
        card.className = "qa-card";
        card.dataset.index = String(index);

        const header = document.createElement("div");
        header.className = "qa-header";

        const headerMain = document.createElement("div");
        headerMain.className = "qa-header-main";

        const titleEl = document.createElement("div");
        titleEl.className = "qa-title";
        titleEl.innerHTML =
          row.Title
            ? highlightText(row.Title, keywords)
            : "(ç„¡æ¨™é¡Œ Title)";

        const metaEl = document.createElement("div");
        metaEl.className = "qa-meta";
        const page = row.Page || "";

        metaEl.innerHTML =
          `<span>ğŸ“… ${year || "?"} / ${quarterRaw || "?"}</span>` +
          `<span>ğŸ“„ Page ${page || "?"}</span>` +
          (row.Sheet ? `<span>ğŸ“‘ Sheetï¼š${escapeHtml(row.Sheet)}</span>` : "");

        const keyEl = document.createElement("div");
        keyEl.className = "qa-keywords";
        if (row.Key) {
          keyEl.innerHTML = `ğŸ”‘ Keyï¼š${highlightText(row.Key, keywords)}`;
        }

        headerMain.appendChild(titleEl);
        headerMain.appendChild(metaEl);
        if (row.Key) headerMain.appendChild(keyEl);

        const toggleIcon = document.createElement("div");
        toggleIcon.className = "qa-toggle-icon";
        toggleIcon.textContent = "ï¼‹";

        header.appendChild(headerMain);
        header.appendChild(toggleIcon);

        const body = document.createElement("div");
        body.className = "qa-body";

        const infoHtml = `
          <div class="qa-field">
            <label>Sheetï¼š</label>
            <div>${escapeHtml(row.Sheet || "")}</div>
          </div>
          <div class="qa-field">
            <label>Quarterï¼š</label>
            <div>${escapeHtml(quarterRaw)}</div>
          </div>
          <div class="qa-field">
            <label>Yearï¼š</label>
            <div>${escapeHtml(year)}</div>
          </div>
          <div class="qa-field">
            <label>Pageï¼š</label>
            <div>${escapeHtml(page)}</div>
          </div>
          <div class="qa-field">
            <label>Titleï¼š</label>
            <div>${highlightText(row.Title || "", keywords)}</div>
          </div>

          <div class="qa-section-title">Question</div>
          <div class="qa-section-text">${highlightText(row.Question || "", keywords)}</div>

          <div class="qa-section-title">Answer</div>
          <div class="qa-section-text">${highlightText(row.Answer || "", keywords)}</div>

          <div class="qa-section-title">Note</div>
          <div class="qa-section-text">${highlightText(row.Note || "", keywords)}</div>

          <div class="qa-section-title">Key</div>
          <div class="qa-section-text">${highlightText(row.Key || "", keywords)}</div>
        `;

        body.innerHTML = infoHtml;

        card.appendChild(header);
        card.appendChild(body);
        resultsContainer.appendChild(card);

        header.addEventListener("click", () => {
          toggleCard(card);
        });
      });
    }

    // Accordionï¼šä¸€æ¬¡åªé–‹ä¸€å¼µå¡ç‰‡
    function toggleCard(card) {
      const isActive = card.classList.contains("active");
      const allCards = document.querySelectorAll(".qa-card");

      allCards.forEach((c) => {
        c.classList.remove("active");
        const body = c.querySelector(".qa-body");
        const icon = c.querySelector(".qa-toggle-icon");
        if (body) body.style.maxHeight = 0;
        if (icon) icon.textContent = "ï¼‹";
      });

      if (!isActive) {
        card.classList.add("active");
        const body = card.querySelector(".qa-body");
        const icon = card.querySelector(".qa-toggle-icon");
        if (body) {
          body.style.maxHeight = "0px";
          const h = body.scrollHeight;
          body.style.maxHeight = h + "px";
        }
        if (icon) icon.textContent = "ï¼";
      }
    }
  </script>
</body>
</html>
