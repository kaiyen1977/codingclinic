<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æœŸåˆŠ QA æœå°‹ï¼ˆæ¨¹ç‹€ç´¢å¼•ç‰ˆï¼‰</title>

  <!-- xlsx.jsï¼šç”¨ä¾†è®€å– Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont,
        "PingFang TC", "Microsoft JhengHei", sans-serif;
      background: #f5f5f7;
      color: #333;
    }

    .app-container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    h1 {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .subtitle {
      font-size: 13px;
      color: #666;
      margin-bottom: 20px;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      padding: 12px 16px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      margin-bottom: 16px;
    }

    .toolbar-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    label {
      font-size: 13px;
      color: #555;
    }

    input[type="file"] {
      font-size: 13px;
    }

    .search-input {
      flex: 1 1 220px;
      min-width: 200px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #ccc;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .search-input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      background: #2563eb;
      color: #fff;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s, box-shadow 0.2s, transform 0.05s;
    }

    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    button:hover {
      background: #1d4ed8;
      box-shadow: 0 4px 10px rgba(37, 99, 235, 0.25);
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
      box-shadow: none;
    }

    .btn-secondary:hover {
      background: #d1d5db;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .status-bar {
      font-size: 13px;
      color: #555;
      margin-bottom: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: baseline;
    }

    .status-bar span { white-space: nowrap; }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e5e7eb;
      font-size: 12px;
      color: #374151;
    }

    .results-container {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .empty-message {
      padding: 24px 16px;
      border-radius: 12px;
      background: #fff;
      text-align: center;
      color: #6b7280;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
    }

    /* === æ¨¹ç‹€ç´¢å¼•æ¨£å¼ === */

    .year-node {
      margin-top: 6px;
    }

    .tree-header {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 3px 6px;
      border-radius: 6px;
      cursor: pointer;
      user-select: none;
    }

    .tree-header:hover {
      background: #e5e7eb;
    }

    .tree-toggle-icon {
      font-size: 11px;
      width: 14px;
      text-align: center;
      color: #4b5563;
    }

    .year-header {
      font-weight: 700;
      font-size: 15px;
      color: #111827;
    }

    .year-children {
      margin-left: 18px;
      margin-top: 2px;
    }

    .quarter-node {
      margin-top: 2px;
    }

    .quarter-header {
      font-weight: 600;
      font-size: 14px;
      color: #1f2933;
    }

    .quarter-children {
      margin-left: 18px;
      padding-left: 8px;
      border-left: 1px dashed #d1d5db;
      margin-top: 2px;
    }

    .title-item {
      margin: 2px 0;
    }

    .title-line {
      display: flex;
      flex-direction: column;
      padding: 2px 4px;
      border-radius: 6px;
      cursor: pointer;
    }

    .title-line:hover {
      background: #f3f4f6;
    }

    .title-main {
      font-size: 14px;
      color: #111827;
    }

    .title-meta {
      font-size: 12px;
      color: #6b7280;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 1px;
    }

    .title-meta span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .title-detail {
      margin: 3px 0 6px 18px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      font-size: 13px;
    }

    .qa-section-title {
      margin-top: 4px;
      margin-bottom: 2px;
      font-size: 13px;
      font-weight: 600;
      color: #4b5563;
    }

    .qa-section-text {
      font-size: 13px;
      color: #111827;
      white-space: pre-wrap;
      word-break: break-word;
      margin-bottom: 4px;
    }

    .highlight {
      background: #fef08a;
      padding: 0 2px;
      border-radius: 3px;
    }

    @media (max-width: 640px) {
      .toolbar {
        align-items: stretch;
      }

      button {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <h1>æœŸåˆŠ QA æœå°‹ç³»çµ±ï¼ˆæ¨¹ç‹€ç´¢å¼•ï¼‰</h1>
    <div class="subtitle">
      å¾ Excel è¼‰å…¥ï¼šQuarter / Year / Page / Title / Question / Answer / Note / Keyã€‚<br>
      ğŸ” é—œéµå­—åªåœ¨ <strong>Question / Answer</strong> ä¸­åš AND æœå°‹ï¼ˆå¤šå€‹é—œéµå­—ç”¨ç©ºç™½åˆ†éš”ï¼‰ï¼Œä¸¦æ”¯æ´ä»£ç¢¼å»æ‰ç¬¦è™Ÿæœå°‹ï¼Œä¾‹å¦‚ï¼š
      <code>COVID-19</code> å¯ç”¨ <code>covid</code> / <code>covid19</code>ï¼›<code>U07.1</code> å¯ç”¨ <code>u07.1</code> / <code>u071</code>ã€‚<br>
      ğŸ“„ æœƒè‡ªå‹•è®€å–ã€Œæ‰€æœ‰å·¥ä½œè¡¨ã€ä¸­æœ‰ Question/Answer æ¬„ä½çš„è³‡æ–™ï¼Œåˆä½µå¾Œä¾ã€Œå¹´ â†’ å­£ â†’ Titleã€åšæ¨¹ç‹€é¡¯ç¤ºã€‚
    </div>

    <div class="toolbar">
      <div class="toolbar-group">
        <label for="fileInput">1. é¸æ“‡ QA Excel æª”ï¼š</label>
        <input id="fileInput" type="file" accept=".xlsx,.xls" />
      </div>

      <div class="toolbar-group" style="flex:1 1 auto;">
        <input
          id="searchInput"
          class="search-input"
          type="text"
          placeholder="2. è«‹è¼¸å…¥é—œéµå­—ï¼ˆç©ºç™½åˆ†éš”ï¼šå¦‚ covid-19 u07.1ï¼‰"
        />
        <button id="searchBtn" type="button">æœå°‹</button>
        <button id="clearBtn" type="button" class="btn-secondary">æ¸…é™¤</button>
      </div>
    </div>

    <div class="status-bar">
      <span id="loadStatus">å°šæœªè¼‰å…¥ Excel æª”</span>
      <span id="resultStatus"></span>
    </div>

    <div id="results" class="results-container">
      <div class="empty-message">
        è«‹å…ˆé¸æ“‡ Excel æª”ï¼Œè¼‰å…¥å®Œæˆå¾Œå³å¯è¼¸å…¥é—œéµå­—æœå°‹ã€‚<br />
        é—œéµå­—ä»¥ç©ºç™½åˆ†éš”ï¼Œ<strong>åªæœƒåœ¨ Question / Answer</strong> ä¸­åš AND æœå°‹ï¼Œä¸¦æ”¯æ´å»æ‰ç¬¦è™Ÿçš„ä»£ç¢¼æœå°‹ã€‚<br>
        çµæœæœƒä»¥ã€Œå¹´ â†’ å­£ â†’ Titleã€çš„æ¨¹ç‹€çµæ§‹å‘ˆç¾ï¼Œé»æ“Š Title å¯å±•é–‹è©³ç´°å…§å®¹ã€‚
      </div>
    </div>
  </div>

  <script>
    let qaData = [];      // æ­£è¦åŒ–å¾Œå®Œæ•´è³‡æ–™
    let filteredData = []; // æœå°‹çµæœ

    const fileInput = document.getElementById("fileInput");
    const searchInput = document.getElementById("searchInput");
    const searchBtn = document.getElementById("searchBtn");
    const clearBtn = document.getElementById("clearBtn");
    const loadStatus = document.getElementById("loadStatus");
    const resultStatus = document.getElementById("resultStatus");
    const resultsContainer = document.getElementById("results");

    fileInput.addEventListener("change", handleFile, false);
    searchBtn.addEventListener("click", doSearch);
    clearBtn.addEventListener("click", () => {
      searchInput.value = "";
      if (qaData.length === 0) return;
      filteredData = qaData;
      renderResults(filteredData, []);
      updateResultStatus();
      searchInput.focus();
    });
    searchInput.addEventListener("keyup", (e) => {
      if (e.key === "Enter") {
        doSearch();
      }
    });

    function normalize(str) {
      return String(str || "").toLowerCase();
    }

    // æœå°‹ç”¨ï¼šåŒæ™‚ä¿ç•™ã€ŒåŸå§‹å°å¯«ã€èˆ‡ã€Œå»æ‰éè‹±æ•¸å­—ã€ç‰ˆæœ¬
    function normalizeForSearch(str) {
      const raw = normalize(str);                 // åŸå§‹å°å¯«ï¼ˆå«ç¬¦è™Ÿï¼‰
      const plain = raw.replace(/[^a-z0-9]/g, ""); // å»æ‰ç¬¦è™Ÿï¼Œåªç•™ a-z0-9
      return { raw, plain };
    }

    function normalizeHeaderName(name) {
      return String(name || "")
        .trim()
        .toLowerCase()
        .replace(/[\s_]+/g, "")
        .replace(/[^a-z0-9]/g, "");
    }

    // æŠŠå­—ä¸²è½‰æˆæ•¸å­—ï¼Œå¤±æ•—å°±çµ¦ 0
    function toNumber(val) {
      const n = parseInt(val, 10);
      return isNaN(n) ? 0 : n;
    }

    // Quarter å¯èƒ½æ˜¯ 1ã€2ã€3ã€4 æˆ– Q1ã€1Q ç­‰ï¼ŒæŠ“è£¡é¢çš„æ•¸å­—
    function toQuarterNumber(val) {
      const m = String(val || "").match(/\d+/);
      if (!m) return 0;
      const n = parseInt(m[0], 10);
      return isNaN(n) ? 0 : n;
    }

    // ä¾ Yearâ†‘ã€Quarterâ†‘ã€Pageâ†‘ æ’åºï¼ˆ2015 â†’ 2016 â†’ 2017ï¼‰
    function sortByYearQuarterPage(arr) {
      return arr.slice().sort((a, b) => {
        const ya = toNumber(a.Year);
        const yb = toNumber(b.Year);
        if (ya !== yb) return ya - yb;        // å¹´åº¦ï¼šå°åˆ°å¤§

        const qa = toQuarterNumber(a.Quarter);
        const qb = toQuarterNumber(b.Quarter);
        if (qa !== qb) return qa - qb;        // å­£åº¦ï¼š1 â†’ 4

        const pa = toNumber(a.Page);
        const pb = toNumber(b.Page);
        return pa - pb;                       // é æ•¸ï¼šå°åˆ°å¤§
      });
    }

    function handleFile(evt) {
      const file = evt.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });

          if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
            loadStatus.textContent = "æ­¤æª”æ¡ˆæ²’æœ‰ä»»ä½•å·¥ä½œè¡¨ã€‚";
            resultsContainer.innerHTML =
              `<div class="empty-message">æª”æ¡ˆç‚ºç©ºã€‚</div>`;
            qaData = [];
            filteredData = [];
            updateResultStatus();
            return;
          }

          const headerCandidates = ["quarter","year","page","title","question","answer","note","key"];

          qaData = [];
          const sheetSummaries = [];

          // ğŸ” é€ä¸€è™•ç†æ‰€æœ‰å·¥ä½œè¡¨ï¼Œæ‰¾åˆ°æœ‰ QA æ¬„ä½çš„å°±åŒ¯å…¥
          workbook.SheetNames.forEach((sheetName) => {
            const ws = workbook.Sheets[sheetName];
            const rows = XLSX.utils.sheet_to_json(ws, {
              header: 1,
              defval: ""
            });
            if (!rows || rows.length === 0) return;

            let headerRowIndex = -1;
            let matchCountOnHeader = 0;

            for (let i = 0; i < rows.length; i++) {
              const row = rows[i];
              if (!row || row.length === 0) continue;
              let matchCount = 0;
              for (let c = 0; c < row.length; c++) {
                const normalized = normalizeHeaderName(row[c]);
                if (headerCandidates.includes(normalized)) {
                  matchCount++;
                }
              }
              if (matchCount >= 2) {
                headerRowIndex = i;
                matchCountOnHeader = matchCount;
                break; // ç”¨ç¬¬ä¸€å€‹ç¬¦åˆçš„æ¨™é¡Œåˆ—
              }
            }

            if (headerRowIndex === -1) {
              // é€™å€‹ sheet æ²’åµæ¸¬åˆ° QA æ¨™é¡Œåˆ—ï¼Œå°±ç•¥é
              return;
            }

            const headerRow = rows[headerRowIndex];
            const dataRows = rows.slice(headerRowIndex + 1);

            let countThisSheet = 0;

            dataRows.forEach((row) => {
              const allEmpty = row.every((cell) => String(cell).trim() === "");
              if (allEmpty) return;

              const obj = {
                Sheet: sheetName,
                Quarter: "",
                Year: "",
                Page: "",
                Title: "",
                Question: "",
                Answer: "",
                Note: "",
                Key: ""
              };

              for (let i = 0; i < headerRow.length; i++) {
                const rawHeader = headerRow[i];
                const cell = row[i];
                const norm = normalizeHeaderName(rawHeader);

                if (norm === "quarter") obj.Quarter = cell;
                else if (norm === "year") obj.Year = cell;
                else if (norm === "page") obj.Page = cell;
                else if (norm === "title") obj.Title = cell;
                else if (norm === "question") obj.Question = cell;
                else if (norm === "answer") obj.Answer = cell;
                else if (norm === "note") obj.Note = cell;
                else if (norm === "key") obj.Key = cell;
              }

              qaData.push(obj);
              countThisSheet++;
            });

            sheetSummaries.push({
              name: sheetName,
              headerRowIndex,
              matchCount: matchCountOnHeader,
              count: countThisSheet
            });
          });

          if (qaData.length === 0) {
            loadStatus.textContent = "æ²’æœ‰åœ¨ä»»ä½•å·¥ä½œè¡¨ä¸­æ‰¾åˆ° Question / Answer ç­‰æ¬„ä½ã€‚";
            resultsContainer.innerHTML =
              `<div class="empty-message">è«‹ç¢ºèª Excel ä¸­è‡³å°‘æœ‰ä¸€å¼µå·¥ä½œè¡¨å« Quarter / Year / Question / Answer ç­‰æ¬„ä½ã€‚</div>`;
            filteredData = [];
            updateResultStatus();
            return;
          }

          // è®€é€²ä¾†å°±å…ˆä¾ Year / Quarter / Page æ’å¥½
          qaData = sortByYearQuarterPage(qaData);
          filteredData = qaData;

          const sheetInfoText = sheetSummaries
            .map(s => `${s.name}ï¼š${s.count} ç­†ï¼ˆæ¨™é¡Œåˆ—ç¬¬ ${s.headerRowIndex + 1} è¡Œï¼ŒåŒ¹é…æ¬„ä½ ${s.matchCount}ï¼‰`)
            .join("ï¼› ");

          loadStatus.textContent =
            `å·²å¾ ${sheetSummaries.length} å€‹å·¥ä½œè¡¨åŒ¯å…¥ï¼Œå…± ${qaData.length} ç­†è³‡æ–™ã€‚${sheetInfoText ? " ä¾†æºï¼š" + sheetInfoText : ""}`;

          renderResults(filteredData, []);
          updateResultStatus();
        } catch (err) {
          console.error(err);
          loadStatus.textContent = "è¼‰å…¥ Excel ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼ã€‚";
          resultsContainer.innerHTML =
            `<div class="empty-message">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª Excel æª”æ¡ˆæ˜¯å¦ç‚ºæ¨™æº– .xlsx / .xls æ ¼å¼ã€‚</div>`;
          qaData = [];
          filteredData = [];
          updateResultStatus();
        }
      };

      reader.readAsArrayBuffer(file);
    }

    function doSearch() {
      if (qaData.length === 0) {
        alert("è«‹å…ˆé¸æ“‡ä¸¦è¼‰å…¥ Excel æª”ã€‚");
        return;
      }

      const rawInput = searchInput.value.trim();
      const keywordsRaw = rawInput
        .split(/\s+/)
        .filter(Boolean);

      if (keywordsRaw.length === 0) {
        filteredData = qaData;
        renderResults(filteredData, []);
        updateResultStatus();
        return;
      }

      const keywordObjs = keywordsRaw.map((kw) => normalizeForSearch(kw));

      filteredData = qaData.filter((row) => {
        // åªåœ¨ Question + Answer è£¡æœå°‹
        const qaText = `${row.Question || ""}  ${row.Answer || ""}`;
        const hay = normalizeForSearch(qaText);

        return keywordObjs.every((k) => {
          if (k.raw && hay.raw.includes(k.raw)) return true;
          if (k.plain && hay.plain.includes(k.plain)) return true;
          return false;
        });
      });

      filteredData = sortByYearQuarterPage(filteredData);

      const keywordForHighlight = keywordObjs.map(k => k.raw).filter(Boolean);
      renderResults(filteredData, keywordForHighlight);
      updateResultStatus(keywordsRaw.map(k => k.toLowerCase()));
    }

    function updateResultStatus(keywords = []) {
      if (qaData.length === 0) {
        resultStatus.textContent = "";
        return;
      }
      if (!keywords || keywords.length === 0) {
        resultStatus.innerHTML =
          `<span class="badge">é¡¯ç¤ºå…¨éƒ¨ ${filteredData.length} ç­†</span>`;
      } else {
        resultStatus.innerHTML =
          `<span class="badge">é—œéµå­—ï¼š${keywords.join(" & ")}</span>` +
          ` <span class="badge">æœå°‹çµæœ ${filteredData.length} ç­†</span>`;
      }
    }

    function highlightText(text, keywords) {
      if (!keywords || keywords.length === 0) return escapeHtml(text);

      let escaped = escapeHtml(text);
      keywords.forEach((kw) => {
        if (!kw) return;
        const pattern = new RegExp("(" + escapeRegExp(kw) + ")", "ig");
        escaped = escaped.replace(pattern, `<span class="highlight">$1</span>`);
      });
      return escaped;
    }

    function escapeHtml(str) {
      return String(str || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function escapeRegExp(str) {
      return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }

    // ç°¡å–®åˆ‡æ›é¡¯ç¤º block/none
    function toggleBlock(elem, iconSpan) {
      if (!elem) return;
      const isHidden = elem.style.display === "none" || elem.style.display === "";
      elem.style.display = isHidden ? "block" : "none";
      if (iconSpan) {
        iconSpan.textContent = isHidden ? "â–¼" : "â–¶";
      }
    }

    // ä¾ Year / Quarter å †ç–Šé¡¯ç¤ºæˆæ¨¹ç‹€
    function renderResults(data, keywords) {
      if (!data || data.length === 0) {
        resultsContainer.innerHTML =
          `<div class="empty-message">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„çµæœã€‚</div>`;
        return;
      }

      resultsContainer.innerHTML = "";

      let currentYear = null;
      let currentYearChildren = null;

      let currentQuarter = null;
      let currentQuarterChildren = null;

      data.forEach((row) => {
        const year = row.Year || "";
        const quarterRaw = row.Quarter || "";

        // === Year ç¯€é» ===
        if (year !== currentYear) {
          currentYear = year;
          currentQuarter = null; // æ–°å¹´ï¼Œå­£è¦é‡ç½®

          const yearNode = document.createElement("div");
          yearNode.className = "year-node";

          const yearHeader = document.createElement("div");
          yearHeader.className = "tree-header year-header";

          const yearIcon = document.createElement("span");
          yearIcon.className = "tree-toggle-icon";
          yearIcon.textContent = "â–¼"; // é è¨­å±•é–‹

          const yearLabel = document.createElement("span");
          yearLabel.textContent = year ? String(year) : "(æœªå¡« Year)";

          yearHeader.appendChild(yearIcon);
          yearHeader.appendChild(yearLabel);

          const yearChildren = document.createElement("div");
          yearChildren.className = "year-children";
          yearChildren.style.display = "block";

          yearHeader.addEventListener("click", () => {
            toggleBlock(yearChildren, yearIcon);
          });

          yearNode.appendChild(yearHeader);
          yearNode.appendChild(yearChildren);
          resultsContainer.appendChild(yearNode);

          currentYearChildren = yearChildren;
          currentQuarterChildren = null;
        }

        // === Quarter ç¯€é» ===
        if (quarterRaw !== currentQuarter) {
          currentQuarter = quarterRaw;

          const quarterNode = document.createElement("div");
          quarterNode.className = "quarter-node";

          const quarterHeader = document.createElement("div");
          quarterHeader.className = "tree-header quarter-header";

          const qIcon = document.createElement("span");
          qIcon.className = "tree-toggle-icon";
          qIcon.textContent = "â–¼"; // é è¨­å±•é–‹

          const qLabel = document.createElement("span");
          const qStr = String(quarterRaw || "").trim();
          if (/^\d+$/.test(qStr)) {
            qLabel.textContent = `Q${qStr}`;
          } else if (qStr) {
            qLabel.textContent = qStr;
          } else {
            qLabel.textContent = "(æœªå¡« Quarter)";
          }

          quarterHeader.appendChild(qIcon);
          quarterHeader.appendChild(qLabel);

          const quarterChildren = document.createElement("div");
          quarterChildren.className = "quarter-children";
          quarterChildren.style.display = "block";

          quarterHeader.addEventListener("click", () => {
            toggleBlock(quarterChildren, qIcon);
          });

          quarterNode.appendChild(quarterHeader);
          quarterNode.appendChild(quarterChildren);

          if (currentYearChildren) {
            currentYearChildren.appendChild(quarterNode);
          } else {
            resultsContainer.appendChild(quarterNode);
          }

          currentQuarterChildren = quarterChildren;
        }

        // === Title ç¯€é» ===
        const titleItem = document.createElement("div");
        titleItem.className = "title-item";

        const titleLine = document.createElement("div");
        titleLine.className = "title-line";

        const titleMain = document.createElement("div");
        titleMain.className = "title-main";
        titleMain.innerHTML =
          row.Title
            ? highlightText(row.Title, keywords)
            : "(ç„¡æ¨™é¡Œ Title)";

        const meta = document.createElement("div");
        meta.className = "title-meta";

        const page = row.Page || "";
        const sheet = row.Sheet || "";

        meta.innerHTML =
          `<span>ğŸ“„ Page ${escapeHtml(page || "?")}</span>` +
          (sheet ? ` <span>ğŸ“‘ Sheetï¼š${escapeHtml(sheet)}</span>` : "") +
          (row.Key ? ` <span>ğŸ”‘ ${highlightText(row.Key, keywords)}</span>` : "");

        titleLine.appendChild(titleMain);
        titleLine.appendChild(meta);

        const detail = document.createElement("div");
        detail.className = "title-detail";
        detail.style.display = "none";

        const detailHtml = `
          <div class="qa-section-title">Quarter / Year / Page</div>
          <div class="qa-section-text">
${escapeHtml(quarterRaw || "")} / ${escapeHtml(year || "")} / ${escapeHtml(page || "")}
          </div>

          <div class="qa-section-title">Title</div>
          <div class="qa-section-text">${highlightText(row.Title || "", keywords)}</div>

          <div class="qa-section-title">Question</div>
          <div class="qa-section-text">${highlightText(row.Question || "", keywords)}</div>

          <div class="qa-section-title">Answer</div>
          <div class="qa-section-text">${highlightText(row.Answer || "", keywords)}</div>

          <div class="qa-section-title">Note</div>
          <div class="qa-section-text">${highlightText(row.Note || "", keywords)}</div>

          <div class="qa-section-title">Key</div>
          <div class="qa-section-text">${highlightText(row.Key || "", keywords)}</div>
        `;
        detail.innerHTML = detailHtml;

        // Title è¡Œæœ¬èº«é»æ“Š â†’ å±•é–‹/æ”¶åˆè©³ç´°å…§å®¹
        titleLine.addEventListener("click", () => {
          toggleBlock(detail, null);
        });

        titleItem.appendChild(titleLine);
        titleItem.appendChild(detail);

        if (currentQuarterChildren) {
          currentQuarterChildren.appendChild(titleItem);
        } else if (currentYearChildren) {
          currentYearChildren.appendChild(titleItem);
        } else {
          resultsContainer.appendChild(titleItem);
        }
      });
    }
  </script>
</body>
</html>
